<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv='cache-control' content='no-cache'> 
  <meta http-equiv='expires' content='0'> 
  <meta http-equiv='pragma' content='no-cache'>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Access Nature</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    #map, #map-container {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    #map-container {
      width: 200%;
      height: 200%;
      position: absolute;
      top: -50%;
      left: -50%;
      transform-origin: center center;
      transition: none;
      z-index: 1;
    }

    /* TOP BAR - FIXED POSITIONING */
    .top-bar {
      position: fixed !important;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000 !important;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 6px 12px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-width: calc(100vw - 20px);
      overflow: hidden;
    }

    /* FLOATING LEFT BUTTONS */
    .floating-left {
      position: fixed !important;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2000 !important;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* FLOATING RIGHT BUTTONS */
    .floating-right {
      position: fixed !important;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2000 !important;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* MEDIA PANEL */
    .media-panel {
      position: fixed !important;
      right: 10px;
      top: 50%;
      transform: translateY(-50%) translateX(60px);
      z-index: 2000 !important;
      display: flex;
      flex-direction: column;
      gap: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .media-panel.open {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(-50%) translateX(0);
    }

    /* BOTTOM NAVIGATION */
    .bottom-nav {
      position: fixed !important;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000 !important;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 6px 12px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-width: calc(100vw - 20px);
      overflow-x: auto;
      overflow-y: visible;
    }

    /* BOTTOM PANELS */
    .bottom-popup {
      position: fixed !important;
      bottom: 70px;
      left: 10px;
      right: 10px;
      z-index: 2000 !important;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      max-height: 50vh;
      overflow-y: auto;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }

    .bottom-popup.hidden {
      display: none !important;
    }

    /* COMPASS AND DEBUG */
    #compass {
      position: fixed !important;
      top: 15px;
      right: 15px;
      z-index: 2500 !important;
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.9);
      border: 2px solid #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transform-origin: center center;
      transition: none;
    }

    #debug {
      position: fixed !important;
      top: 75px;
      right: 15px;
      z-index: 2500 !important;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 6px;
      font-family: monospace;
      font-size: 10px;
      border-radius: 4px;
      display: none;
      max-width: 120px;
    }

    /* ACCESSIBILITY OVERLAY */
    #accessibilityOverlay {
      position: fixed !important;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 3000 !important;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
      padding: 10px;
    }

    #accessibilityFormContainer {
      position: relative;
      background: white;
      color: black;
      max-height: calc(100vh - 20px);
      max-width: calc(100vw - 20px);
      width: 500px;
      overflow-y: auto;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      padding: 16px;
      direction: rtl;
      text-align: right;
    }

    /* ROUND BUTTONS */
/*     .round-button {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      z-index: inherit;
      flex-shrink: 0;
    } */

/*     .round-button:hover {
      background: rgba(240, 240, 240, 0.95);
      transform: scale(1.05);
    }
 */
    .round-button:active {
      transform: scale(0.95);
    }
    .round-button {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: black;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.round-button:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
}

.round-button svg {
    width: 24px;
    height: 24px;
    fill: none;
    stroke: white;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

    /* REGULAR BUTTONS */
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 12px;
      margin: 2px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
      flex-shrink: 0;
      white-space: nowrap;
    }

    button:hover {
      background-color: #45a049;
      transform: translateY(-1px);
    }

    button:disabled {
      background-color: #ccc !important;
      color: #888 !important;
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* NAVIGATION BUTTON STYLES */
    .bottom-nav button {
      background: #f0f0f0;
      color: #333;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 12px;
      min-width: auto;
      flex-shrink: 0;
    }

    .bottom-nav button:hover {
      background: #e0e0e0;
    }

    /* FORM STYLES */
    #accessibilityForm {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #accessibilityForm label {
      display: block;
      margin-top: 6px;
      font-weight: bold;
      font-size: 13px;
    }

    #accessibilityForm input,
    #accessibilityForm select,
    #accessibilityForm textarea {
      width: 100%;
      margin-top: 4px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    #accessibilityForm button {
      margin-top: 12px;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 8px;
    }

    /* COMPASS NEEDLE */
    #compass-needle {
      width: 2px;
      height: 30px;
      position: relative;
      transform-origin: center bottom;
    }

    #compass-needle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -3px;
      width: 0;
      height: 0;
      border-left: 3px solid transparent;
      border-right: 3px solid transparent;
      border-bottom: 15px solid #e74c3c;
    }

    #compass-needle::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: -3px;
      width: 0;
      height: 0;
      border-left: 3px solid transparent;
      border-right: 3px solid transparent;
      border-top: 15px solid #34495e;
    }

    #compass-center {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #2c3e50;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* DARK MODE */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }

    body.dark-mode .top-bar,
    body.dark-mode .bottom-nav,
    body.dark-mode .bottom-popup {
      background: rgba(30, 30, 30, 0.95);
      color: #e0e0e0;
    }

    body.dark-mode .round-button {
      background: rgba(50, 50, 50, 0.9);
      color: #e0e0e0;
    }

    body.dark-mode button {
      background-color: #333;
      color: white;
    }

    body.dark-mode .bottom-nav button {
      background: #444;
      color: #e0e0e0;
    }

    body.dark-mode .bottom-nav button:hover {
      background: #555;
    }

    /* TOGGLE PANEL */
    .toggle-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      margin-top: 8px;
    }

    .toggle-panel.open {
      max-height: 400px;
    }

    /* TIMER AND DISTANCE DISPLAY */
    #timer, #distance {
      font-family: monospace;
      font-weight: bold;
      font-size: 18px;
      color: #333;
      white-space: nowrap;
    }

    body.dark-mode #timer,
    body.dark-mode #distance {
      color: #e0e0e0;
    }

    /* HIDDEN ELEMENTS */
    .sessions,
    #controls,
    #historyPanel,
    #photoInput,
    #videoInput,
    #importFile,
    #developerToolsPanel {
      display: none !important;
    }

.storage-monitor {
  position: fixed !important;
  font-family: monospace;
  top: 70px; /* 10px (top-bar top) + 44px (estimated top-bar height) + 6px (top-bar padding) + 5px (desired gap) + 5px buffer */
  left: 50%;
  transform: translateX(-50%);
  width: 250px;
  max-height: 90vh;
  background:rgba(0,0,0,0.7);
  border: 1px solid #999;
  border-radius: 5px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  font-family: Arial, sans-serif;
  font-size: 14px;
  padding: 10px;
  z-index: 2100 !important; /* Higher than top-bar (2000) but lower than compass (2500) */
  color: #fff;
}

.storage-monitor img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 3px;
  border: 1px solid #999;
}

.storage-monitor button {
  font-size: 12px;
  cursor: pointer;
}

#localStorageStatus.dragging {
  transition: none !important;
  cursor: move;
}

#storageHeader {
  padding: 8px;
  background: black;
  color: #fff;
  font-family: monospace;
  font-weight: bold;
  cursor: grab;
  user-select: none;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
  .storage-monitor {
    top: 65px; /* Adjusted for mobile top-bar positioning */
    left: 50%;
  
  width: 250px;
    transform: none;
  }
}

@media (max-width: 480px) {
  .storage-monitor {
    top: 60px;
    left: 70px;
  
  width: 250px;
    max-height: 70vh;
  }
}

/* Landscape orientation adjustment */
@media (max-height: 500px) and (orientation: landscape) {
  .storage-monitor {
    top: 45px; /* Adjusted for landscape top-bar positioning */
    max-height: 60vh;
  }
}
    /* MOBILE RESPONSIVE DESIGN */
    @media (max-width: 768px) {
      .top-bar {
        top: 5px;
        left: 5px;
        right: 5px;
        transform: none;
        gap: 6px;
        padding: 4px 8px;
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      
      .bottom-nav {
        bottom: 5px;
        left: 5px;
        right: 5px;
        transform: none;
        gap: 4px;
        padding: 4px 8px;
      }
      
      .bottom-popup {
        bottom: 60px;
        left: 5px;
        right: 5px;
        padding: 10px;
        max-height: 40vh;
      }
      
      .floating-left {
        left: 5px;
        gap: 6px;
      }
      
      .floating-right {
        right: 5px;
        gap: 6px;
      }
      
      .media-panel {
        right: 5px;
        transform: translateY(-50%) translateX(50px);
        gap: 6px;
      }
      
      #compass {
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
      }
      
      #debug {
        top: 60px;
        right: 10px;
        font-size: 9px;
        padding: 4px;
        max-width: 100px;
      }
      
      #accessibilityFormContainer {
        padding: 12px;
        margin: 5px;
      }
    }

    @media (max-width: 480px) {
      .top-bar {
        gap: 4px;
        padding: 4px 6px;
      }
      
      .round-button {
        width: 38px;
        height: 38px;
        font-size: 16px;
      }
      
      button {
        padding: 6px 10px;
        font-size: 12px;
      }
      
      .bottom-nav button {
        padding: 6px 8px;
        font-size: 11px;
      }
      
      #timer, #distance {
        font-size: 14px;
      }
      
      .bottom-popup {
        gap: 4px;
        padding: 8px;
      }
      
      #compass {
        width: 35px;
        height: 35px;
      }
      
      #compass-needle {
        height: 25px;
      }
      
      #compass-needle::before,
      #compass-needle::after {
        border-width: 2px;
      }
      
      #compass-needle::before {
        border-bottom-width: 12px;
      }
      
      #compass-needle::after {
        border-top-width: 12px;
      }
    }

    @media (max-width: 360px) {
      .top-bar {
        padding: 3px 4px;
        gap: 3px;
      }
      
      .round-button {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }
      
      button {
        padding: 5px 8px;
        font-size: 11px;
      }
      
      .bottom-nav button {
        padding: 5px 6px;
        font-size: 10px;
      }
      
      #timer, #distance {
        font-size: 14px;
      }
      
      .floating-left, .floating-right {
        gap: 4px;
      }
      
      .media-panel {
        gap: 4px;
      }
    }

    /* LANDSCAPE ORIENTATION */
    @media (max-height: 500px) and (orientation: landscape) {
      .top-bar {
        top: 3px;
        padding: 2px 6px;
      }
      
      .bottom-nav {
        bottom: 3px;
        padding: 2px 6px;
      }
      
      .bottom-popup {
        bottom: 40px;
        max-height: 30vh;
      }
      
      .floating-left, .floating-right {
        top: 40%;
        gap: 4px;
      }
      
      .round-button {
        width: 35px;
        height: 35px;
      }
      
      #compass {
        top: 5px;
        right: 5px;
        width: 30px;
        height: 30px;
      }
    }

     /* TOUCH OPTIMIZATION */
    @media (hover: none) and (pointer: coarse) {
      .round-button {
        min-width: 44px;
        min-height: 44px;
      }
      
      button {
        min-height: 40px;
        padding: 8px 12px;
      }
      
      .bottom-nav button {
        min-height: 36px;
        padding: 6px 10px;
      }
    }

    /* HIGH DPI DISPLAYS */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .round-button,
      button {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
    }
  </style>
</head>
<body>

<div id="debug"></div>

<div id="compass">
  <div id="compass-needle"></div>
  <div id="compass-center"></div>
</div>

<div id="map-container">
  <div id="map"></div>
</div>

<!-- Top tracker bar -->
<div class="top-bar">
  <button id="startBtn" class="round-button" onclick="startTracking()">▶️</button>
  <button id="pauseBtn" class="round-button" onclick="togglePause()">⏸</button>
  <button id="stopBtn" class="round-button" onclick="stopTracking()">⏹</button>
  <span id="timer">00:00:00</span>
  <span>|</span>
  <span id="distance">0.00 km</span>
</div>

  <div id="localStorageStatus" class="storage-monitor">
    <div id="storageHeader" style="cursor: pointer;">📦 localStorage Monitor ▼</div>
    <div id="storageContent"></div>
    <audio id="storageAlertAudio" style="display:none">
      <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAgD4AAAB9AAACABAAZGF0YQAAAAA=" type="audio/wav">
    </audio>
  </div>
  
<!-- Floating control buttons -->
<div class="floating-left">
  <button id="toggleBtn" class="round-button"><svg viewBox="0 0 24 24">
        <path d="M12 2l3 3-3 3"/>
        <path d="M9 12h6"/>
        <path d="M21 12c0 5-4 9-9 9s-9-4-9-9 4-9 9-9"/>
        <path d="M16 16l-4-4"/>
    </svg></button>
  <button class="round-button" onclick="openAccessibilityForm()"><svg viewBox="0 0 1300 1390" xmlns="http://www.w3.org/2000/svg">
  <circle cx="650" cy="695" r="650" fill="black"/>
  <g fill="white">
    <path d="M 117 0 L 116 1 L 110 1 L 109 2 L 104 2 L 103 3 L 100 3 L 99 4 L 96 4 L 95 5 L 93 5 L 92 6 L 90 6 L 89 7 L 87 7 L 86 8 L 84 8 L 83 9 L 82 9 L 81 10 L 80 10 L 79 11 L 77 11 L 76 12 L 75 12 L 74 13 L 73 13 L 72 14 L 71 14 L 70 15 L 69 15 L 68 16 L 67 16 L 65 18 L 64 18 L 63 19 L 62 19 L 60 21 L 59 21 L 57 23 L 56 23 L 54 25 L 53 25 L 49 29 L 48 29 L 42 35 L 41 35 L 35 41 L 35 42 L 29 48 L 29 49 L 25 53 L 25 54 L 23 56 L 23 57 L 21 59 L 21 60 L 19 62 L 19 63 L 18 64 L 18 65 L 16 67 L 16 68 L 15 69 L 15 70 L 14 71 L 14 72 L 13 73 L 13 74 L 12 75 L 12 76 L 11 77 L 11 79 L 10 80 L 10 81 L 9 82 L 9 83 L 8 84 L 8 86 L 7 87 L 7 89 L 6 90 L 6 92 L 5 93 L 5 95 L 4 96 L 4 99 L 3 100 L 3 104 L 2 105 L 2 110 L 1 111 L 1 118 L 0 119 L 0 1182 L 1 1183 L 1 1189 L 2 1190 L 2 1194 L 3 1195 L 3 1199 L 4 1200 L 4 1202 L 5 1203 L 5 1206 L 6 1207 L 6 1209 L 7 1210 L 7 1212 L 8 1213 L 8 1215 L 9 1216 L 9 1217 L 10 1218 L 10 1219 L 11 1220 L 11 1222 L 12 1223 L 12 1224 L 13 1225 L 13 1226 L 14 1227 L 14 1228 L 15 1229 L 15 1230 L 16 1231 L 16 1232 L 17 1233 L 17 1234 L 19 1236 L 19 1237 L 21 1239 L 21 1240 L 23 1242 L 23 1243 L 25 1245 L 25 1246 L 29 1250 L 29 1251 L 37 1259 L 37 1260 L 42 1265 L 43 1265 L 49 1271 L 50 1271 L 53 1274 L 54 1274 L 56 1276 L 57 1276 L 59 1278 L 60 1278 L 62 1280 L 63 1280 L 64 1281 L 65 1281 L 66 1282 L 67 1282 L 69 1284 L 70 1284 L 71 1285 L 72 1285 L 73 1286 L 74 1286 L 75 1287 L 76 1287 L 77 1288 L 79 1288 L 80 1289 L 81 1289 L 82 1290 L 83 1290 L 84 1291 L 86 1291 L 87 1292 L 89 1292 L 90 1293 L 92 1293 L 93 1294 L 95 1294 L 96 1295 L 99 1295 L 100 1296 L 104 1296 L 105 1297 L 109 1297 L 110 1298 L 116 1298 L 117 1299 L 116 1300 L 0 1300 L 0 1389 L 1299 1389 L 1299 1300 L 1183 1300 L 1182 1299 L 1183 1298 L 1189 1298 L 1190 1297 L 1194 1297 L 1195 1296 L 1199 1296 L 1200 1295 L 1202 1295 L 1203 1294 L 1206 1294 L 1207 1293 L 1209 1293 L 1210 1292 L 1212 1292 L 1213 1291 L 1215 1291 L 1216 1290 L 1217 1290 L 1218 1289 L 1219 1289 L 1220 1288 L 1222 1288 L 1223 1287 L 1224 1287 L 1225 1286 L 1226 1286 L 1227 1285 L 1228 1285 L 1229 1284 L 1230 1284 L 1231 1283 L 1232 1283 L 1234 1281 L 1235 1281 L 1236 1280 L 1237 1280 L 1239 1278 L 1240 1278 L 1242 1276 L 1243 1276 L 1245 1274 L 1246 1274 L 1249 1271 L 1250 1271 L 1256 1265 L 1257 1265 L 1265 1257 L 1265 1256 L 1270 1251 L 1270 1250 L 1274 1246 L 1274 1245 L 1276 1243 L 1276 1242 L 1278 1240 L 1278 1239 L 1280 1237 L 1280 1236 L 1281 1235 L 1281 1234 L 1283 1232 L 1283 1231 L 1284 1230 L 1284 1229 L 1285 1228 L 1285 1227 L 1286 1226 L 1286 1225 L 1287 1224 L 1287 1223 L 1288 1222 L 1288 1220 L 1289 1219 L 1289 1218 L 1290 1217 L 1290 1216 L 1291 1215 L 1291 1213 L 1292 1212 L 1292 1210 L 1293 1209 L 1293 1207 L 1294 1206 L 1294 1203 L 1295 1202 L 1295 1200 L 1296 1199 L 1296 1195 L 1297 1194 L 1297 1190 L 1298 1189 L 1298 1183 L 1299 1182 L 1299 117 L 1298 116 L 1298 110 L 1297 109 L 1297 104 L 1296 103 L 1296 100 L 1295 99 L 1295 96 L 1294 95 L 1294 93 L 1293 92 L 1293 90 L 1292 89 L 1292 87 L 1291 86 L 1291 85 L 1290 84 L 1290 82 L 1289 81 L 1289 80 L 1288 79 L 1288 77 L 1287 76 L 1287 75 L 1286 74 L 1286 73 L 1285 72 L 1285 71 L 1284 70 L 1284 69 L 1282 67 L 1282 66 L 1281 65 L 1281 64 L 1280 63 L 1280 62 L 1278 60 L 1278 59 L 1276 57 L 1276 56 L 1274 54 L 1274 53 L 1271 50 L 1271 49 L 1264 42 L 1264 41 L 1260 37 L 1259 37 L 1251 29 L 1250 29 L 1246 25 L 1245 25 L 1243 23 L 1242 23 L 1240 21 L 1239 21 L 1237 19 L 1236 19 L 1234 17 L 1233 17 L 1232 16 L 1231 16 L 1230 15 L 1229 15 L 1228 14 L 1227 14 L 1226 13 L 1225 13 L 1224 12 L 1223 12 L 1222 11 L 1220 11 L 1219 10 L 1218 10 L 1217 9 L 1216 9 L 1215 8 L 1213 8 L 1212 7 L 1210 7 L 1209 6 L 1207 6 L 1206 5 L 1203 5 L 1202 4 L 1200 4 L 1199 3 L 1195 3 L 1194 2 L 1190 2 L 1189 1 L 1183 1 L 1182 0 Z"/>
  </g>
</svg></button>
  <button class="round-button" onclick="toggleDarkMode()">🌓</button>
</div>
<!-- ♿🧭 -->
<div class="floating-right">
  <button class="round-button" onclick="toggleMediaPanel()">➕</button>
</div>

<div class="media-panel" id="mediaPanel">
  <button id="takePhotoBtn" class="round-button" onclick="capturePhoto()">📸</button>
  <button class="round-button" onclick="addTextNote()">📝</button>
  <button class="round-button" onclick="showRouteDataOnMap()">🗺️</button>
</div>

<!-- Bottom Navigation Bar -->
<div id="bottomNav" class="bottom-nav">
  <button onclick="togglePanel('exportPanel')">📤 Export</button>
  <button onclick="togglePanel('summaryPanel')">📚 Summaries</button>
  <button onclick="togglePanel('devToolsPanel')">🛠️ Dev Tools</button>
</div>

<!-- Panels -->
<div id="exportPanel" class="bottom-popup hidden">
  <button id="prepareAndExportBtn" onclick="prepareAndExport()">📦 Export Last Route</button>
  <button id="exportAllRoutesBtn" onclick="exportAllRoutes()">🌍 Export All Routes</button>
  <button id="exportDataBtn" onclick="exportData()">📄 JSON</button>
  <button id="exportPDFBtn" onclick="exportPDF()">📄 PDF</button>
  <button id="exportGPXBtn" onclick="exportGPX()">📍 GPX</button>
</div>

<div id="summaryPanel" class="bottom-popup hidden">
  <button id="toggleArchivePanelBtn" onclick="toggleArchivePanel()">📜 Browse Summaries</button>
  <div id="archivePanel" class="toggle-panel"></div>
  <button id="clearArchiveBtnBtn" onclick="SummaryArchive.clearAll()">🗑️ Clear All Summaries</button>
  <button id="clearAllSessionsBtn" onclick="clearAllSessions()">🗑️ Clear Saved Routes</button>
  <button id="clearAllAppDataBtn" onclick="clearAllAppData()">🧹 Clear Everything</button>
</div>

<div id="devToolsPanel" class="bottom-popup hidden">
  <button onclick="showStorageMonitor()">🧪 Storage Monitor</button>
  <button onclick="triggerImport()">📥 Import Route (JSON/GPX)</button>
  <button id="resetBtn" onclick="confirmAndResetApp()">📍 Reset App</button>
</div>

<!-- Accessibility Form -->
<div id="accessibilityOverlay" style="display:none;">
  <div id="accessibilityFormContainer">
    <h2>🧭 Accessibility Questionnaire</h2>
    <form id="accessibilityForm">
      <button type="button" onclick="closeAccessibilityForm()">🚪 Close</button>

      <label>Disabled Parking Spaces - Count:</label>
      <input type="number" name="disabledParkingCount" required>
      <label>Photo:</label>
      <input type="file" name="disabledParkingImage" accept="image/*">

      <label>Path Description:</label>
      <select name="pathType" required>
        <option value="">Select</option>
        <option>Asphalt</option>
        <option>Concrete</option>
        <option>Wooden Deck</option>
        <option>Dirt Path (Not Accessible)</option>
      </select>
      <label>Photo:</label>
      <input type="file" name="pathImage" accept="image/*">

      <label>Accessible Path Length (meters):</label>
      <input type="number" name="accessibleLength" required>

      <label>Route Type:</label>
      <select name="routeType">
        <option>Out and Back</option>
        <option>Loop</option>
      </select>

      <label>Trail Slope:</label>
      <select name="slope">
        <option>Flat</option>
        <option>Moderate Slopes</option>
        <option>Steep Slopes (Not Accessible)</option>
      </select>

      <label>Points of Interest:</label>
      <textarea name="pointsOfInterest" rows="3"></textarea>
      <label>Photo:</label>
      <input type="file" name="poiImage" accept="image/*">

      <label>Viewpoints:</label>
      <input type="checkbox" name="lookouts"> Available
      <label>Photo:</label>
      <input type="file" name="lookoutImage" accept="image/*">

      <label>Accessible Picnic Areas:</label>
      <input type="checkbox" name="picnicSpots"> Available
      <label>Photo:</label>
      <input type="file" name="picnicImage" accept="image/*">

      <label>Accessible Restrooms:</label>
      <input type="checkbox" name="accessibleToilets"> Available
      <label>Photo:</label>
      <input type="file" name="toiletImage" accept="image/*">

      <label>Benches Along Path:</label>
      <input type="checkbox" name="benches"> Available
      <label>Photo:</label>
      <input type="file" name="benchImage" accept="image/*">

      <label>Shade:</label>
      <select name="shade">
        <option>Shaded</option>
        <option>Partially Shaded</option>
        <option>No Shade</option>
      </select>

      <button type="submit">✔️ Save</button>
      <button type="button" onclick="closeAccessibilityForm()">❌ Cancel</button>
    </form>
  </div>
</div>

<!-- Hidden elements preserved for app logic -->
<div id="controls" style="display:none;"></div>
<div id="historyPanel" style="display:none;"><ul id="historyList"></ul></div>
<input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none;" />
<input type="file" id="videoInput" accept="video/*" capture style="display:none;" />
<input type="file" id="importFile" accept=".json,.gpx" style="display:none;" />

<div class="sessions" style="display:none;">
  <h3>📂 Saved Routes</h3>
  <ul id="savedSessionsList"></ul>
</div>

<script>
// Toggle media panel
function toggleMediaPanel() {
  const panel = document.getElementById("mediaPanel");
  panel.classList.toggle("open");
}

// Toggle bottom panels
function togglePanel(panelId) {
  // Hide all panels first
  const panels = document.querySelectorAll('.bottom-popup');
  panels.forEach(panel => {
    if (panel.id !== panelId) {
      panel.classList.add('hidden');
    }
  });
  
  // Toggle the requested panel
  const targetPanel = document.getElementById(panelId);
  if (targetPanel) {
    targetPanel.classList.toggle('hidden');
  }
}

// Dark mode toggle
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

// Load dark mode preference
if (localStorage.getItem('darkMode') === 'true') {
  document.body.classList.add('dark-mode');
}

// Accessibility form functions
function openAccessibilityForm() {
  document.getElementById('accessibilityOverlay').style.display = 'flex';
}

function closeAccessibilityForm() {
  document.getElementById('accessibilityOverlay').style.display = 'none';
}

// Placeholder functions for app functionality
function startTracking() { console.log('Start tracking'); }
function togglePause() { console.log('Toggle pause'); }
function stopTracking() { console.log('Stop tracking'); }
function capturePhoto() { console.log('Capture photo'); }
function addTextNote() { console.log('Add text note'); }
function showRouteDataOnMap() { console.log('Show route data'); }
function prepareAndExport() { console.log('Prepare and export'); }
function exportAllRoutes() { console.log('Export all routes'); }
function exportData() { console.log('Export data'); }
function exportPDF() { console.log('Export PDF'); }
function exportGPX() { console.log('Export GPX'); }
function toggleArchivePanel() { console.log('Toggle archive panel'); }
function clearAllSessions() { console.log('Clear all sessions'); }
function clearAllAppData() { console.log('Clear all app data'); }
function showStorageMonitor() { console.log('Show storage monitor'); }
function triggerImport() { console.log('Trigger import'); }
function confirmAndResetApp() { console.log('Confirm and reset app'); }

// Compass and rotation functionality
let rotationEnabled = false;
let currentHeading = 0;
let smoothedHeading = 0;
let animationFrameId = null;
let lastUpdateTime = 0;
let headingHistory = [];
const HISTORY_SIZE = 5;
const SMOOTHING_FACTOR = 0.15;
const MIN_CHANGE_THRESHOLD = 0.3;

const mapContainer = document.getElementById('map-container');
const toggleBtn = document.getElementById('toggleBtn');
const debugDiv = document.getElementById('debug');
const compassDiv = document.getElementById('compass');

// Initialize map (placeholder)
// const map = L.map('map').setView([51.505, -0.09], 13);
// L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
//   attribution: '&copy; OpenStreetMap contributors'
// }).addTo(map);

// Utility functions for compass
function normalizeAngle(angle) {
  return ((angle % 360) + 360) % 360;
}

function angleDifference(target, current) {
  const diff = normalizeAngle(target - current);
  return diff > 180 ? diff - 360 : diff;
}

function addToHistory(heading) {
  headingHistory.push(heading);
  if (headingHistory.length > HISTORY_SIZE) {
    headingHistory.shift();
  }
}

function getSmoothedHeading() {
  if (headingHistory.length === 0) return currentHeading;
  
  let sinSum = 0, cosSum = 0;
  for (let heading of headingHistory) {
    const rad = heading * Math.PI / 180;
    sinSum += Math.sin(rad);
    cosSum += Math.cos(rad);
  }
  
  const avgRad = Math.atan2(sinSum / headingHistory.length, cosSum / headingHistory.length);
  return normalizeAngle(avgRad * 180 / Math.PI);
}

// Toggle button handler
  toggleBtn.addEventListener('click', () => {
    rotationEnabled = !rotationEnabled;
    toggleBtn.style.backgroundColor = rotationEnabled ? "green" : "black";
    
    if (rotationEnabled) {
      // Initialize smoothed heading to current heading
      smoothedHeading = currentHeading;
      headingHistory = [currentHeading];
      debugDiv.style.display = 'block';
      startRotationLoop();
    } else {
      cancelAnimationFrame(animationFrameId);
      mapContainer.style.transform = 'rotate(0deg)';
      compassDiv.style.transform = 'rotate(0deg)';
      debugDiv.style.display = 'none';
    }
  });

  // Enhanced compass reading with error checking
  function handleOrientation(event) {
    let heading = null;
    
    // Try different compass heading sources
    if (typeof event.webkitCompassHeading !== "undefined") {
      heading = event.webkitCompassHeading;
    } else if (event.alpha !== null && event.alpha !== undefined) {
      heading = 360 - event.alpha; // Convert to compass heading
    }
    
    // Validate heading
    if (heading !== null && !isNaN(heading) && isFinite(heading)) {
      heading = normalizeAngle(heading);
      
      // Only update if significant change to reduce noise
      const change = Math.abs(angleDifference(heading, currentHeading));
      if (change > MIN_CHANGE_THRESHOLD || headingHistory.length === 0) {
        currentHeading = heading;
        addToHistory(heading);
      }
    }
  }

  // Request permission for device orientation on iOS
  function requestOrientationPermission() {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      DeviceOrientationEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === 'granted') {
            attachOrientationListeners();
          } else {
            alert('Device orientation permission denied');
          }
        })
        .catch(console.error);
    } else {
      attachOrientationListeners();
    }
  }

  function attachOrientationListeners() {
    if ('ondeviceorientationabsolute' in window) {
      window.addEventListener('deviceorientationabsolute', handleOrientation, true);
    } else {
      window.addEventListener('deviceorientation', handleOrientation, true);
    }
  }

  // Start rotation animation loop
  function startRotationLoop() {
    if (!rotationEnabled) return;
    
    const now = performance.now();
    const deltaTime = now - lastUpdateTime;
    
    // Throttle updates to ~60fps
    if (deltaTime >= 16) {
      updateRotation();
      lastUpdateTime = now;
    }
    
    animationFrameId = requestAnimationFrame(startRotationLoop);
  }

  // Smooth rotation update
  function updateRotation() {
    if (!rotationEnabled) return;
    
    const targetHeading = getSmoothedHeading();
    const diff = angleDifference(targetHeading, smoothedHeading);
    
    // Apply exponential smoothing
    smoothedHeading += diff * SMOOTHING_FACTOR;
    smoothedHeading = normalizeAngle(smoothedHeading);
    
    // Only apply transform if change is significant
    if (Math.abs(diff) > 0.1) {
      mapContainer.style.transform = `rotate(${-smoothedHeading}deg)`;
      compassDiv.style.transform = `rotate(${smoothedHeading}deg)`;
    }
    
    // Update debug info
    debugDiv.innerHTML = `
      Raw: ${currentHeading.toFixed(1)}°<br>
      Target: ${targetHeading.toFixed(1)}°<br>
      Smooth: ${smoothedHeading.toFixed(1)}°<br>
      Diff: ${diff.toFixed(1)}°
    `;
  }

  // Initialize orientation listeners
  if (window.location.protocol === 'https:') {
    requestOrientationPermission();
  } else {
    attachOrientationListeners();
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Leaflet Control Geocoder CSS + JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
/>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="app.js"></script>

<!-- Developer Tools Panel -->
<div id="developerToolsPanel" class="bottom-panel" style="display:none;">
  <button onclick="toggleDarkMode()">🌙☀️ Dark/Light Mode</button>
  <button id="clearAllAppDataBtn" onclick="clearAllAppData()">🧹 Clear Everything</button>
  <button id="clearAllSessionsBtn" onclick="clearAllSessions()">🗑️ Clear All Saved Routes</button>
  <button id="resetBtn" onclick="confirmAndResetApp()">📍**!Reset App!**📍</button>
  <button onclick="triggerImport()">📥 Import Route (JSON/GPX)</button>
  <button onclick="showPhotoCleanupDialog()">📥 Handle photos (JSON/GPX)</button>
</div>

</body>
</html>
