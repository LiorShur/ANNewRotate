<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv='cache-control' content='no-cache'> 
  <meta http-equiv='expires' content='0'> 
  <meta http-equiv='pragma' content='no-cache'>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Access Nature</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    #map, #map-container {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    #map-container {
      width: 200%;
      height: 200%;
      position: absolute;
      top: -50%;
      left: -50%;
      transform-origin: center center;
      transition: none;
      z-index: 1;
    }

    /* TOP BAR - FIXED POSITIONING */
    .top-bar {
      position: fixed !important;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000 !important;
      display: flex;
      gap: 10px;
      align-items: center;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 8px 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* FLOATING LEFT BUTTONS */
    .floating-left {
      position: fixed !important;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2000 !important;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* FLOATING RIGHT BUTTONS */
    .floating-right {
      position: fixed !important;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2000 !important;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* MEDIA PANEL */
    .media-panel {
      position: fixed !important;
      right: 15px;
      top: 50%;
      transform: translateY(-50%) translateX(70px);
      z-index: 2000 !important;
      display: flex;
      flex-direction: column;
      gap: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .media-panel.open {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(-50%) translateX(0);
    }

    /* BOTTOM NAVIGATION */
    .bottom-nav {
      position: fixed !important;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000 !important;
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 8px 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* BOTTOM PANELS */
    .bottom-popup {
      position: fixed !important;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000 !important;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      max-height: 50vh;
      overflow-y: auto;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .bottom-popup.hidden {
      display: none !important;
    }

    /* COMPASS AND DEBUG */
    #compass {
      position: fixed !important;
      top: 20px;
      right: 20px;
      z-index: 2500 !important;
      width: 60px;
      height: 60px;
      background: rgba(255,255,255,0.9);
      border: 2px solid #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transform-origin: center center;
      transition: none;
    }

    #debug {
      position: fixed !important;
      top: 90px;
      right: 20px;
      z-index: 2500 !important;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px;
      font-family: monospace;
      font-size: 12px;
      border-radius: 4px;
      display: none;
    }

    /* ACCESSIBILITY OVERLAY */
    #accessibilityOverlay {
      position: fixed !important;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 3000 !important;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
    }

    #accessibilityFormContainer {
      position: relative;
      background: white;
      max-height: 90vh;
      max-width: 90vw;
      width: 500px;
      overflow-y: auto;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      padding: 20px;
      direction: rtl;
      text-align: right;
    }

    /* ROUND BUTTONS */
    .round-button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      z-index: inherit;
    }

    .round-button:hover {
      background: rgba(240, 240, 240, 0.95);
      transform: scale(1.05);
    }

    .round-button:active {
      transform: scale(0.95);
    }

    /* REGULAR BUTTONS */
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 16px;
      margin: 4px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    button:hover {
      background-color: #45a049;
      transform: translateY(-1px);
    }

    button:disabled {
      background-color: #ccc !important;
      color: #888 !important;
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* NAVIGATION BUTTON STYLES */
    .bottom-nav button {
      background: #f0f0f0;
      color: #333;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      min-width: 80px;
    }

    .bottom-nav button:hover {
      background: #e0e0e0;
    }

    /* FORM STYLES */
    #accessibilityForm {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #accessibilityForm label {
      display: block;
      margin-top: 8px;
      font-weight: bold;
      font-size: 14px;
    }

    #accessibilityForm input,
    #accessibilityForm select,
    #accessibilityForm textarea {
      width: 100%;
      margin-top: 4px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    #accessibilityForm button {
      margin-top: 16px;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 8px;
    }

    /* COMPASS NEEDLE */
    #compass-needle {
      width: 2px;
      height: 40px;
      position: relative;
      transform-origin: center bottom;
    }

    #compass-needle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -3px;
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 20px solid #e74c3c;
    }

    #compass-needle::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: -3px;
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 20px solid #34495e;
    }

    #compass-center {
      position: absolute;
      width: 6px;
      height: 6px;
      background: #2c3e50;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* DARK MODE */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }

    body.dark-mode .top-bar,
    body.dark-mode .bottom-nav,
    body.dark-mode .bottom-popup {
      background: rgba(30, 30, 30, 0.95);
      color: #e0e0e0;
    }

    body.dark-mode .round-button {
      background: rgba(50, 50, 50, 0.9);
      color: #e0e0e0;
    }

    body.dark-mode button {
      background-color: #333;
      color: white;
    }

    body.dark-mode .bottom-nav button {
      background: #444;
      color: #e0e0e0;
    }

    body.dark-mode .bottom-nav button:hover {
      background: #555;
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 600px) {
      .top-bar, .bottom-nav {
        left: 10px;
        right: 10px;
        transform: none;
      }
      
      .bottom-popup {
        left: 10px;
        right: 10px;
        transform: none;
      }
      
      .floating-left {
        left: 10px;
      }
      
      .floating-right {
        right: 10px;
      }
      
      #compass {
        right: 10px;
      }
      
      #debug {
        right: 10px;
      }
    }

    @media (max-width: 400px) {
      .round-button {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      
      .top-bar, .bottom-nav {
        padding: 6px 12px;
      }
      
      button {
        padding: 8px 12px;
        font-size: 13px;
      }
    }

    /* HIDDEN ELEMENTS */
    .sessions,
    #controls,
    #historyPanel,
    #photoInput,
    #videoInput,
    #importFile,
    #developerToolsPanel {
      display: none !important;
    }

    /* TOGGLE PANEL */
    .toggle-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      margin-top: 8px;
    }

    .toggle-panel.open {
      max-height: 400px;
    }

    /* TIMER AND DISTANCE DISPLAY */
    #timer, #distance {
      font-family: monospace;
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }

    body.dark-mode #timer,
    body.dark-mode #distance {
      color: #e0e0e0;
    }
  </style>
</head>
<body>

<div id="debug"></div>

<div id="compass">
  <div id="compass-needle"></div>
  <div id="compass-center"></div>
</div>

<div id="map-container">
  <div id="map"></div>
</div>

<!-- Top tracker bar -->
<div class="top-bar">
  <button id="startBtn" class="round-button" onclick="startTracking()">‚ñ∂Ô∏è</button>
  <button id="pauseBtn" class="round-button" onclick="togglePause()">‚è∏</button>
  <button id="stopBtn" class="round-button" onclick="stopTracking()">‚èπ</button>
  <span id="timer">00:00:00</span>
  <span>|</span>
  <span id="distance">0.00 km</span>
</div>

<!-- Floating control buttons -->
<div class="floating-left">
  <button id="toggleBtn" class="round-button">üß≠</button>
  <button class="round-button" onclick="openAccessibilityForm()">‚ôø</button>
  <button class="round-button" onclick="toggleDarkMode()">üåì</button>
</div>

<div class="floating-right">
  <button class="round-button" onclick="toggleMediaPanel()">‚ûï</button>
</div>

<div class="media-panel" id="mediaPanel">
  <button id="takePhotoBtn" class="round-button" onclick="capturePhoto()">üì∏</button>
  <button class="round-button" onclick="addTextNote()">üìù</button>
  <button class="round-button" onclick="showRouteDataOnMap()">üó∫Ô∏è</button>
</div>

<!-- Bottom Navigation Bar -->
<div id="bottomNav" class="bottom-nav">
  <button onclick="togglePanel('exportPanel')">üì§ Export</button>
  <button onclick="togglePanel('summaryPanel')">üìö Summaries</button>
  <button onclick="togglePanel('devToolsPanel')">üõ†Ô∏è Dev Tools</button>
</div>

<!-- Panels -->
<div id="exportPanel" class="bottom-popup hidden">
  <button id="prepareAndExportBtn" onclick="prepareAndExport()">üì¶ Export Last Route</button>
  <button id="exportAllRoutesBtn" onclick="exportAllRoutes()">üåç Export All Routes</button>
  <button id="exportDataBtn" onclick="exportData()">üìÑ JSON</button>
  <button id="exportPDFBtn" onclick="exportPDF()">üìÑ PDF</button>
  <button id="exportGPXBtn" onclick="exportGPX()">üìç GPX</button>
</div>

<div id="summaryPanel" class="bottom-popup hidden">
  <button id="toggleArchivePanelBtn" onclick="toggleArchivePanel()">üìú Browse Summaries</button>
  <div id="archivePanel" class="toggle-panel"></div>
  <button id="clearArchiveBtnBtn" onclick="SummaryArchive.clearAll()">üóëÔ∏è Clear All Summaries</button>
  <button id="clearAllSessionsBtn" onclick="clearAllSessions()">üóëÔ∏è Clear Saved Routes</button>
  <button id="clearAllAppDataBtn" onclick="clearAllAppData()">üßπ Clear Everything</button>
</div>

<div id="devToolsPanel" class="bottom-popup hidden">
  <button onclick="showStorageMonitor()">üß™ Storage Monitor</button>
  <button onclick="triggerImport()">üì• Import Route (JSON/GPX)</button>
  <button id="resetBtn" onclick="confirmAndResetApp()">üìç Reset App</button>
</div>

<!-- Accessibility Form -->
<div id="accessibilityOverlay" style="display:none;">
  <div id="accessibilityFormContainer">
    <h2>üß≠ Accessibility Questionnaire</h2>
    <form id="accessibilityForm">
      <button type="button" onclick="closeAccessibilityForm()">üö™ Close</button>

      <label>Disabled Parking Spaces - Count:</label>
      <input type="number" name="disabledParkingCount" required>
      <label>Photo:</label>
      <input type="file" name="disabledParkingImage" accept="image/*">

      <label>Path Description:</label>
      <select name="pathType" required>
        <option value="">Select</option>
        <option>Asphalt</option>
        <option>Concrete</option>
        <option>Wooden Deck</option>
        <option>Dirt Path (Not Accessible)</option>
      </select>
      <label>Photo:</label>
      <input type="file" name="pathImage" accept="image/*">

      <label>Accessible Path Length (meters):</label>
      <input type="number" name="accessibleLength" required>

      <label>Route Type:</label>
      <select name="routeType">
        <option>Out and Back</option>
        <option>Loop</option>
      </select>

      <label>Trail Slope:</label>
      <select name="slope">
        <option>Flat</option>
        <option>Moderate Slopes</option>
        <option>Steep Slopes (Not Accessible)</option>
      </select>

      <label>Points of Interest:</label>
      <textarea name="pointsOfInterest" rows="3"></textarea>
      <label>Photo:</label>
      <input type="file" name="poiImage" accept="image/*">

      <label>Viewpoints:</label>
      <input type="checkbox" name="lookouts"> Available
      <label>Photo:</label>
      <input type="file" name="lookoutImage" accept="image/*">

      <label>Accessible Picnic Areas:</label>
      <input type="checkbox" name="picnicSpots"> Available
      <label>Photo:</label>
      <input type="file" name="picnicImage" accept="image/*">

      <label>Accessible Restrooms:</label>
      <input type="checkbox" name="accessibleToilets"> Available
      <label>Photo:</label>
      <input type="file" name="toiletImage" accept="image/*">

      <label>Benches Along Path:</label>
      <input type="checkbox" name="benches"> Available
      <label>Photo:</label>
      <input type="file" name="benchImage" accept="image/*">

      <label>Shade:</label>
      <select name="shade">
        <option>Shaded</option>
        <option>Partially Shaded</option>
        <option>No Shade</option>
      </select>

      <button type="submit">‚úîÔ∏è Save</button>
      <button type="button" onclick="closeAccessibilityForm()">‚ùå Cancel</button>
    </form>
  </div>
</div>

<!-- Hidden elements preserved for app logic -->
<div id="controls" style="display:none;"></div>
<div id="historyPanel" style="display:none;"><ul id="historyList"></ul></div>
<input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none;" />
<input type="file" id="videoInput" accept="video/*" capture style="display:none;" />
<input type="file" id="importFile" accept=".json,.gpx" style="display:none;" />

<div class="sessions" style="display:none;">
  <h3>üìÇ Saved Routes</h3>
  <ul id="savedSessionsList"></ul>
</div>

<script>
// Toggle media panel
function toggleMediaPanel() {
  const panel = document.getElementById("mediaPanel");
  panel.classList.toggle("open");
}

// Toggle bottom panels
function togglePanel(panelId) {
  // Hide all panels first
  const panels = document.querySelectorAll('.bottom-popup');
  panels.forEach(panel => {
    if (panel.id !== panelId) {
      panel.classList.add('hidden');
    }
  });
  
  // Toggle the requested panel
  const targetPanel = document.getElementById(panelId);
  if (targetPanel) {
    targetPanel.classList.toggle('hidden');
  }
}

// Dark mode toggle
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

// Load dark mode preference
if (localStorage.getItem('darkMode') === 'true') {
  document.body.classList.add('dark-mode');
}

// Accessibility form functions
function openAccessibilityForm() {
  document.getElementById('accessibilityOverlay').style.display = 'flex';
}

function closeAccessibilityForm() {
  document.getElementById('accessibilityOverlay').style.display = 'none';
}

// Placeholder functions for app functionality
function startTracking() { console.log('Start tracking'); }
function togglePause() { console.log('Toggle pause'); }
function stopTracking() { console.log('Stop tracking'); }
function capturePhoto() { console.log('Capture photo'); }
function addTextNote() { console.log('Add text note'); }
function showRouteDataOnMap() { console.log('Show route data'); }
function prepareAndExport() { console.log('Prepare and export'); }
function exportAllRoutes() { console.log('Export all routes'); }
function exportData() { console.log('Export data'); }
function exportPDF() { console.log('Export PDF'); }
function exportGPX() { console.log('Export GPX'); }
function toggleArchivePanel() { console.log('Toggle archive panel'); }
function clearAllSessions() { console.log('Clear all sessions'); }
function clearAllAppData() { console.log('Clear all app data'); }
function showStorageMonitor() { console.log('Show storage monitor'); }
function triggerImport() { console.log('Trigger import'); }
function confirmAndResetApp() { console.log('Confirm and reset app'); }

// Compass and rotation functionality
let rotationEnabled = false;
let currentHeading = 0;
let smoothedHeading = 0;
let animationFrameId = null;
let lastUpdateTime = 0;
let headingHistory = [];
const HISTORY_SIZE = 5;
const SMOOTHING_FACTOR = 0.15;
const MIN_CHANGE_THRESHOLD = 0.3;

const mapContainer = document.getElementById('map-container');
const toggleBtn = document.getElementById('toggleBtn');
const debugDiv = document.getElementById('debug');
const compassDiv = document.getElementById('compass');

// Initialize map (placeholder)
// const map = L.map('map').setView([51.505, -0.09], 13);
// L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
//   attribution: '&copy; OpenStreetMap contributors'
// }).addTo(map);

// Utility functions for compass
function normalizeAngle(angle) {
  return ((angle % 360) + 360) % 360;
}

function angleDifference(target, current) {
  const diff = normalizeAngle(target - current);
  return diff > 180 ? diff - 360 : diff;
}

function addToHistory(heading) {
  headingHistory.push(heading);
  if (headingHistory.length > HISTORY_SIZE) {
    headingHistory.shift();
  }
}

function getSmoothedHeading() {
  if (headingHistory.length === 0) return currentHeading;
  
  let sinSum = 0, cosSum = 0;
  for (let heading of headingHistory) {
    const rad = heading * Math.PI / 180;
    sinSum += Math.sin(rad);
    cosSum += Math.cos(rad);
  }
  
  const avgRad = Math.atan2(sinSum / headingHistory.length, cosSum / headingHistory.length);
  return normalizeAngle(avgRad * 180 / Math.PI);
}

// Toggle button handler
toggleBtn.addEventListener('click', () => {
  rotationEnabled = !rotationEnabled;
  toggleBtn.style.background = rotationEnabled ? 'rgba(76, 175, 80, 0.9)' : 'rgba(255, 255, 255, 0.9)';
  
  if (rotationEnabled) {
    smoothedHeading = currentHeading;
    headingHistory = [currentHeading];
    debugDiv.style.display = 'block';
    startRotationLoop();
  } else {
    cancelAnimationFrame(animationFrameId);
    mapContainer.style.transform = 'rotate(0deg)';
    compassDiv.style.transform = 'rotate(0deg)';
    debugDiv.style.display = 'none';
  }
});

// Orientation handling
function handleOrientation(event) {
  let heading = null;
  
  if (typeof event.webkitCompassHeading !== "undefined") {
    heading = event.webkitCompassHeading;
  } else if (event.alpha !== null && event.alpha !== undefined) {
    heading = 360 - event.alpha;
  }
  
  if (heading !== null && !isNaN(heading) && isFinite(heading)) {
    heading = normalizeAngle(heading);
    
    const change = Math.abs(angleDifference(heading, currentHeading));
    if (change > MIN_CHANGE_THRESHOLD || headingHistory.length === 0) {
      currentHeading = heading;
      addToHistory(heading);
    }
  }
}

function requestOrientationPermission() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(permissionState => {
        if (permissionState === 'granted') {
          attachOrientationListeners();
        } else {
          alert('Device orientation permission denied');
        }
      })
      .catch(console.error);
  } else {
    attachOrientationListeners();
  }
}

function attachOrientationListeners() {
  if ('ondeviceorientationabsolute' in window) {
    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
  } else {
    window.addEventListener('deviceorientation', handleOrientation, true);
  }
}

function startRotationLoop() {
  if (!rotationEnabled) return;
  
  const now = performance.now();
  const deltaTime = now - lastUpdateTime;
  
  if (deltaTime >= 16) {
    updateRotation();
    lastUpdateTime = now;
  }
  
  animationFrameId = requestAnimationFrame(startRotationLoop);
}

function updateRotation() {
  if (!rotationEnabled) return;
  
  const targetHeading = getSmoothedHeading();
  const diff = angleDifference(targetHeading, smoothedHeading);
  
  smoothedHeading += diff * SMOOTHING_FACTOR;
  smoothedHeading = normalizeAngle(smoothedHeading);
  
  if (Math.abs(diff) > 0.1) {
    mapContainer.style.transform = `rotate(${-smoothedHeading}deg)`;
    compassDiv.style.transform = `rotate(${smoothedHeading}deg)`;
  }
  
  debugDiv.innerHTML = `
    Raw: ${currentHeading.toFixed(1)}¬∞<br>
    Target: ${targetHeading.toFixed(1)}¬∞<br>
    Smooth: ${smoothedHeading.toFixed(1)}¬∞<br>
    Diff: ${diff.toFixed(1)}¬∞
  `;
}

// Initialize orientation listeners
if (window.location.protocol === 'https:') {
  requestOrientationPermission();
} else {
  attachOrientationListeners();
}

// Handle form submission
document.getElementById('accessibilityForm').addEventListener('submit', function(e) {
  e.preventDefault();
  console.log('Form submitted');
  closeAccessibilityForm();
});

</script>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="app.js"></script>

</body>
</html>
